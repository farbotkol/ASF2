<apex:page standardController="POHeader__c" extensions="ECO_PurchaseOrderSummaryController">
	
	<apex:includeScript value="{!URLFOR($Resource.ECO_jQuery_1_11_2_min_js)}" />
	<apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js" />

	<link rel="stylesheet" type="text/css" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/redmond/jquery-ui.css"/>
	<style>
		table.list .headerRow th{
			font-size:1.1em !important;
		}

		.archive{
			background-color: #BDBDBD;
		}
	</style>
    
    <style>
		.largerTextBox {
			width: 85%;
		}
		
		div.attachmentModal {
			//display: none;
		}
		
		.percentInput{
		  float: right;
		  z-index: 999;
		  margin-right: -45px;
		  margin-top: 1px;
		  color: #A7A7A7;
		}
		
		.smallInput {
			width: 46px;
			float:right;
			line-height:14px;
			height: 19px;
		}
		.fileList
		{
			padding-top: 5px;
			padding-bottom: 5px;
		}		
		
  		.attachNewFile{
  			visibility: hidden;
  		}	
        
        .customHelpText{
            padding:7px;
            border:1px solid #85B3CE;
            min-height:30px;
            display:block;
            width:auto;
            margin:0;
        //  background-color:#C6E4EE;
            background-color:#A2D3F1;
            background-repeat:no-repeat;
            border-radius:4px;
        }
        
        .customHelpBody{
            display:block;
            color:#;
            max-width:95%;
        }
        
        .mouseOverInfoOuter{
        	text-align:left;
        }
	</style>
    
	<apex:form >
		<script type='text/javascript'>
			var doSync = "false";
		</script>

		<apex:outputPanel id="autoApproveSuccessCheck">
            <script type='text/javascript'>
                doSync = "{!isApprovedDoSyncNow}";			
            </script>
		</apex:outputPanel>
	
		<script type='text/javascript'>
			j$ = jQuery.noConflict();

			var poLineItemModal = null;

        /*function showDialog(modalTitle){
				
             	poLineItemModal = j$("#divTest").dialog({
						             		autoOpen: false,
								            title: modalTitle,
								            resizable: true,
								            width: 'auto',
								            height: 'auto',
								            autoResize: true,
								            modal: true,
								            draggable: true
						             	});
             	poLineItemModal.dialog('open');       		
             	
			}*/

        /*function closeDialog(){
				poLineItemModal.dialog('close');   
				//vf rerender wasn't working - workaround for that
				//setTimeout(doRerenderPOListItems_JS, 1000);				
			}*/

        /*function closeDialogAndReRender(){
				closeDialog();
				doRerenderPOListItems_JS();
			}*/

        /*function save2(){
				closeDialog();
				saveCurrentPOLineItem_JS();
			}*/

        /*function addNewPOLineItem(){
				var url = "/apex/ECO_ProjectTaskSearch?projectId={!poHeader.Project__c}&poHeaderId={!poHeader.Id}";
				j$("[id*=iPOLineItem]").attr('src', url);
				showDialog('Add New Purchase Order Line Item');
			}*/
		
			function submitForApproval(){
				var purchaseOrderId = "{!poHeader.Id}";
				var url = "/p/process/Submit?id={!poHeader.Id}&retURL=%2F{!poHeader.Id}";
				alert(url);
				navigateToUrl(url);		
			}

			function SaveAndSubmitPurchaseOrder(){				
				purchaseOrderStatus = "{!poHeader.Status__c}";
                if(purchaseOrderStatus == 'APPROVED') {
                    saveAndSubmitForApproval_JS();
                }
                else {
                    var confirmMsg = "Submit Purchase Order for Approval?";
                    if (Modal.confirm && Modal.confirm(confirmMsg)){
                        saveAndSubmitForApproval_JS();
                    }
                }
			}

			function SyncPurchaseOrderIfAutoApproved(){				
				if(doSync == "true"){
					createMessageQueueRecord_start_JS();
				}
			}

			function doMessageQueuePolling(){
				if(pollMessageQueue == "true") {
					var timerVal = document.getElementById('pollingTimer').innerHTML; 		    	
				    var seconds = parseInt(timerVal);
			 
				    if (seconds == 1) {
				      temp = document.getElementById('pollingTimer');
				      temp2 = document.getElementById('pollingTimerBottom');
				      temp.innerHTML = "checking if processed";
				      temp2.innerHTML = "checking if processed";
				      checkIfSyncHasBeenProcessed_JS();
				      return;
				    }
		 
				    seconds--;
				    temp = document.getElementById('pollingTimer');
				    temp2 = document.getElementById('pollingTimerBottom');
				    temp.innerHTML = seconds;
				    temp2.innerHTML = seconds;
				    var timeoutFunction = setTimeout(doMessageQueuePolling, 1000);
				}
			}

			function changeVendor(vendorId){
				//alert(vendorId);
				j$("[id*=selectedVendorId]").val(vendorId); 
				getDefaultPaymentTermsForVendor_JS();
			}

			function confirmCancelPurchaseOrder(){
				if(confirm("Are you sure you want to cancel this purchase order?")){
					cancelPurchaseOrder_JS();
				}
			}
        
            function authenticate() {
                authenticateCredentials($x('[id$=username]').val(), $x('[id$=password]').val());
            }
        
            function cancelModal() {
                closeModal('modalDialogOracleLogin');
                return false;
            }
        
        	function closeAuthenticationModal(){
                closeModal('modalDialogOracleLogin');
                closeAuthenticationWindow();
                return false;
            }
		</script>

		<!--apex:actionFunction action="{!gotoPOLineItemPage}" name="addNewPOLineItem_JS" oncomplete="showDialog();" reRender="pbCurrentPOLineItem"/-->
		<!--apex:actionFunction action="{!doRerenderPOListItems}" name="doRerenderPOListItems_JS" reRender="pbStatus,pbsDistributions,msgPanel,btnSync,msgValidation"/-->
		<apex:actionFunction action="{!initiateOracleSyncRequest}" name="initiateOracleSyncRequest_JS" status="statusBar" oncomplete="executeOracleSyncRequest_JS();"/>
        <apex:actionFunction action="{!executeOracleSyncRequest}" name="executeOracleSyncRequest_JS" status="statusBar" reRender="msg,syncHistorySection,statusBar"/>	
        <apex:actionFunction action="{!saveAndSubmitForApproval}" name="saveAndSubmitForApproval_JS" status="statusBar" reRender="msg,statusBar,approvalHistory,autoApproveSuccessCheck" oncomplete="SyncPurchaseOrderIfAutoApproved();" />	
		<apex:actionFunction action="{!createMessageQueueRecord_start}" name="createMessageQueueRecord_start_JS" oncomplete="createMessageQueueRecord_complete_JS();" reRender="msgPanel,msgPanelBottom,msgPollingTop,msgPollingBottom" status="statusBar"/>	
		<apex:actionFunction action="{!createMessageQueueRecord_complete}" name="createMessageQueueRecord_complete_JS" oncomplete="sendPOSyncRequest_start_JS();" reRender="msgPanel,msgPanelBottom" status="statusBar"/>
		<apex:actionFunction action="{!sendPOSyncRequest_start}" name="sendPOSyncRequest_start_JS" oncomplete="sendPOSyncRequest_complete_JS();" reRender="msgPanel,msgPanelBottom,msgPollingTop,msgPollingBottom" status="statusBar"/>
		<apex:actionFunction action="{!sendPOSyncRequest_complete}" name="sendPOSyncRequest_complete_JS" oncomplete="sendPOSyncRequest_Finish_JS();" reRender="msgPanel,msgPanelBottom,syncHistorySection" status="statusBar"/>
		<apex:actionFunction action="{!sendPOSyncRequest_Finish}" name="sendPOSyncRequest_Finish_JS" reRender="msgPanel,msgPanelBottom,pbStatus,pbtValidPOLineItems,pbsPOHeader,txtJSON,btnSavePOHeader" status="statusBar"/>
    	<apex:actionFunction action="{!checkIfSyncHasBeenProcessed}" name="checkIfSyncHasBeenProcessed_JS" reRender="msgPollingTop,msgPollingBottom,syncHistorySection" oncomplete="doMessageQueuePolling();"/>
		<apex:actionFunction action="{!getDefaultPaymentTermsForVendor}" name="getDefaultPaymentTermsForVendor_JS" reRender="pohAgreement, pohPaymentTerm, vendorSection" />
		<apex:actionFunction action="{!cancelPurchaseOrder}" name="cancelPurchaseOrder_JS" reRender="msg,statusBar,approvalHistory,autoApproveSuccessCheck" status="statusBar" oncomplete="SyncPurchaseOrderIfAutoApproved();" />
		<div style="display:none;">
			<apex:inputText value="{!selectedVendorId}" id="selectedVendorId" />
		</div>
		<apex:sectionHeader subtitle="Purchase Order Summary" title=" Sync Purchase Order " >
			<apex:actionStatus id="statusBar">
                <apex:facet name="start">
                    <p style="padding-bottom:20px;" class="searchText"><img style="position:relative;top:12px;" src="/img/loading32.gif" /> Processing...</p>
                </apex:facet>
                <apex:facet name="stop">
                </apex:facet>
			</apex:actionStatus>
		</apex:sectionHeader>

		<apex:outputPanel id="msgPanel">
            <apex:pageMessage detail="Your Oracle Login has expired and you are required to login to Oracle before Synching the Purchase Order. Please click the Login button and enter your Oracle credentials." severity="warning" strength="2" title="Expired Oracle Login" rendered="{!NOT($User.IsValidOracleToken__c)}"/>
			<apex:pageMessages id="msg" escape="false"></apex:pageMessages>
        </apex:outputPanel>

		<apex:outputPanel id="msgPolling" >
			<div style="display:{!if(showPollingMsg==true, 'block', 'none')}">
				<apex:pageMessage escape="false" summary="{!pollingMessageQueueMsg}" severity="INFO" ></apex:pageMessage>
			</div>
		</apex:outputPanel>

		<apex:outputPanel rendered="{!!hideEverything}">
            <apex:outputPanel id="msgValidation">
            	<apex:pageMessage summary="{!validationMsgSummary}" severity="warning" strength="3" rendered="{!showValidationMsg}" escape="false"/>
            </apex:outputPanel>
		</apex:outputPanel>
		
		<apex:pageMessage summary="The purchase order is pending approval." severity="INFO" rendered="{!pendingApproval}" />
		<div class="customHelpText">
            <div class="customHelpBody">
                The raising of a Purchase Order for a Sub Contract or Vendor Agreement enables tracking of the committed costs against a project, as well as complance with finance policies regarding the capturing of purchase committments within Oracle.  To raise a PO, complete the following steps:<br/>
                1.  Select the Vendor and input the minimum fields required, the hit "Save Purchase Order"<br/>
                2.  Add as many PO Line Items as required<br/>
                3.  Submit for approval.  Once approve d the PO will be created in Oracle and an Oracle PO Nubmer provided - this number should be given to the sub/vendor to quote on their subsequent invoices.<br/><br/>
	
					Please note - Advantage should be used for the purchase of indirect materials., the ePM Purchase Order functionality should only be used in relation to project specific subs or specialised vendor services/supplies.
            </div>
        </div>
		<apex:pageBlock rendered="{!!hideEverything}">
            
            <apex:pageBlockButtons location="top">
                <!-- creates purchase order header -->
                <apex:commandButton value="{!savePOBtnValue}" action="{!updatePurchaseOrder}" rendered="{!canEditHeader}" reRender="msg" id="btnSavePOHeader" />
                <apex:commandButton value="{!if(poheader.Status__c == 'APPROVED', 'Sync Purchase Order', 'Submit for Approval')}" onclick="SaveAndSubmitPurchaseOrder(); return false;" reRender="syncHistorySection,pbtValidPOLineItems,btnSyncWithProgress" disabled="{!!allowRequestSubmit}" id="btnSyncWithProgress" rendered="{!if(allowNewPOLineItems == true && pendingApproval == false && $User.IsValidOracleToken__c, 'true', 'false')}"/>
                <apex:commandButton value="Delete" immediate="true" action="{!deletePurchaseOrder}" rendered="{!if(poheader.Status__c != 'APPROVED', 'true', 'false')}"/>
                <apex:commandButton value="Closeout Purchase Order" action="{!closeOutPurchaseOrder}" status="statusBar" disabled="{!!allowPOCloseout}" rendered="{!allowRequestSubmit}" />
                <apex:commandButton value="Cancel Purchase Order" onclick="confirmCancelPurchaseOrder(); return false;" disabled="{!!allowPOCancel}" rendered="{!allowRequestSubmit}" />
                <apex:commandButton value="{!returnBtnValue}" action="{!returnToProject}" />
                <apex:commandButton action="{!SimulateProcessedByOracle}" value="Mock PO Number Sent Back"  rendered="{!if(hasSyncHistory && poHeader.OraclePurchaseOrderId__c == null, 'true', 'false')}"/>
                <apex:commandButton action="{!SimulateInvoicedByOracle}" value="Mock PO Invoiced"  rendered="{!if(poHeader.OraclePurchaseOrderId__c != null && poStatus.AP_Invoice__c == null, 'true', 'false')}"/>
                <apex:commandButton value="Login to Oracle" onclick="openModal('modalDialogOracleLogin');return false;" rendered="{!NOT($User.IsValidOracleToken__c)}"/>
            </apex:pageBlockButtons>
            <apex:pageBlockSection columns="1">
                <apex:pageBlockSectionItem >
                    <apex:tabPanel switchType="client" selectedTab="tabPOSummary">
                        <apex:tab label="Purchase Order Summary" id="tabPOSummary">
                            <apex:pageBlock >
                                <apex:pageBlockSection columns="2" title="Purchase Order Information" id="pbsPOHeader">
                                    <apex:pageBlockSectionItem rendered="{!allowNewPOLineItems}">
                                        <apex:outputLabel value="Purchase Order Number" for="PO_NUMBER" />
                                        <apex:outputField value="{!poHeader.OraclePurchaseOrderNumber__c}" id="PO_NUMBER" />							
                                    </apex:pageBlockSectionItem>
            
                                    <apex:pageBlockSectionItem >
                                        <apex:outputPanel >
                                            <apex:outputLabel value="{!$ObjectType.POHeader__c.Fields.Project__c.Label}" for="pohProject"/>                    
                                            <c:ECO_HelpIcon helpText="This is the project this PO relates to.  This will be automatically determined by how you access/create the PO." />
                                        </apex:outputPanel>                                       
                                        <apex:outputField value="{!poHeader.Project__c}" id="pohProject" />
                                    </apex:pageBlockSectionItem>
    
                                    <apex:pageBlockSectionItem rendered="{!allowNewPOLineItems}">
                                        <apex:outputLabel value="{!$ObjectType.POHeader__c.Fields.Status__c.Label}" for="pohStatus" />
                                        <apex:outputField value="{!poHeader.Status__c}" id="pohStatus" />							
                                    </apex:pageBlockSectionItem>

                                    <apex:pageBlockSectionItem >
                                        <apex:outputPanel >
                                            <apex:outputLabel value="Sub / Vendor" for="pohProjSite"/>                    
                                            <c:ECO_HelpIcon helpText="Choose a Sub/Vendor to raise the PO against.  Subs/Vendors must be added to the project team via the Subs & Vendors page to be available for selection here." />
                                        </apex:outputPanel>                                        
                                        <apex:outputPanel >
                                            <div class="requiredInput">
                    							<div class="requiredBlock"></div>
                                                <apex:selectList value="{!selProjectSiteId}" size="1" id="pohProjSite" rendered="{!canEditHeader}" onchange="changeVendor(this.options[this.selectedIndex].value);">
                                                    <apex:selectOptions value="{!optSelectProjectSites}"/>
                                                </apex:selectList>	
                                                <apex:outputText value="{!poHeader.VendorName__c}" rendered="{!!canEditHeader}"/>
                                            </div>
                                        </apex:outputPanel>				
                                    </apex:pageBlockSectionItem>
                                    
                                    <apex:pageBlockSectionItem >
                                        <apex:outputPanel >
                                            <apex:outputLabel value="{!$ObjectType.POHeader__c.Fields.Agreement__c.Label}" for="pohAgreement"/>                   
                                            <c:ECO_HelpIcon helpText="Select the agreement the PO relates to (e.g. the Subs agreement created 
                                                                      in the Agreements page).  In the case of vendors where no specific agreement 
                                                                      has been entered into , this field can be left blank" />
                                        </apex:outputPanel>                                        
                                        <apex:outputPanel id="pohAgreementSec">
                                            <apex:selectList value="{!poHeader.Agreement__c}" size="1" id="pohAgreement" rendered="{!canEditHeader}">
                                                <apex:selectOptions value="{!optAgreements}"/>
                                            </apex:selectList>
                                            <apex:outputText value="{!agreementIdentifier}" rendered="{!!canEditHeader}"/>
                                        </apex:outputPanel>							
                                    </apex:pageBlockSectionItem>
            
                                    <apex:pageBlockSectionItem >
                                        <apex:outputPanel >
                                            <apex:outputLabel value="Currency" for="pohCurrencyIsoCode"/>                    
                                            <c:ECO_HelpIcon helpText="Select the currency for the Purchase Order to be raised in (this would typically 
                                                                      be the currency of the agreement with the sub/vendor)" />
                                        </apex:outputPanel>
                                        <apex:outputPanel >
                                            <apex:inputField value="{!poHeader.CurrencyIsoCode}" id="pohCurrencyIsoCode" rendered="{!canEditHeader}"/>
                                            <apex:outputText value="{!poHeader.CurrencyIsoCode}" rendered="{!!canEditHeader}"/>
                                        </apex:outputPanel>		
                                    </apex:pageBlockSectionItem>
                            
                                    <apex:pageBlockSectionItem >
                                        <apex:outputPanel >
                                            <apex:outputLabel value="{!$ObjectType.POHeader__c.Fields.Requestor__c.Label}" for="pohRequestor"/>                   
                                            <c:ECO_HelpIcon helpText="Search & Select for the name of the Requestor (i.e. person raising the PO).  
                                                                      This is typically the PM, but may be a task manager, discipline leader who 
                                                                      has responbility for managing the sub/vendor." />
                                        </apex:outputPanel>                                        
                                        <apex:outputPanel >
                                        	<apex:inputField required="true" value="{!poHeader.Requestor__c}" id="pohRequestor" rendered="{!canEditHeader}"/>
                                        	<apex:outputText value="{!poHeader.Requestor__r.Name}" rendered="{!!canEditHeader}"/>
                                        </apex:outputPanel>	
                                    </apex:pageBlockSectionItem>
            
                                    <apex:pageBlockSectionItem >
                                        <apex:outputPanel >
                                            <apex:outputLabel value="{!$ObjectType.POHeader__c.Fields.PaymentTerm__c.Label}" for="pohPaymentTerm"/>                   
                                            <c:ECO_HelpIcon helpText="Select the payment terms for this Purchase Order.  These may be pre-populated based 
                                                                      on the default for the sub/vendor selected, but should be updated to reflect the 
                                                                      agreed terms per the subs contract if required." />
                                        </apex:outputPanel>
                                        <apex:outputPanel >
                                            <apex:inputField value="{!poHeader.PaymentTerm__c}" id="pohPaymentTerm" rendered="{!canEditHeader}"/>
                                            <apex:outputText value="{!poHeader.PaymentTerm__c}" rendered="{!!canEditHeader}"/>
                                        </apex:outputPanel>
                                    </apex:pageBlockSectionItem>
                                </apex:pageBlockSection>
    
                                <apex:pageBlockSection id="vendorSection" columns="2" title="Sub / Vender Information" rendered="{!allowNewPOLineItems}">
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="{!$ObjectType.POHeader__c.Fields.VendorName__c.Label}" for="pohVendorName"/>
                                        <apex:outputField value="{!poHeader.VendorName__c}" id="pohVendorName" />
                                    </apex:pageBlockSectionItem>
            
                                    <apex:pageBlockSectionItem >
                                        &nbsp;
                                    </apex:pageBlockSectionItem>
            
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="Address" for="pohOracleVendorAddress"/>
                                        <apex:outputField value="{!poHeader.VendorSite__r.Address1__c}" id="pohOracleVendorAddress" />
                                    </apex:pageBlockSectionItem>
            
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="{!$ObjectType.POHeader__c.Fields.OracleVendorId__c.Label}" for="pohOracleVendorId"/>
                                        <apex:outputField value="{!poHeader.OracleVendorId__c}" id="pohOracleVendorId" />
                                    </apex:pageBlockSectionItem>
            
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="{!$ObjectType.VendorSite__c.Fields.City__c.Label}" for="pohOracleVendorCity"/>
                                        <apex:outputField value="{!poHeader.VendorSite__r.City__c}" id="pohOracleVendorCity" />
                                    </apex:pageBlockSectionItem>
            
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="{!$ObjectType.POHeader__c.Fields.OracleVendorNumber__c.Label}" for="pohOracleVendorNumber"/>
                                        <apex:outputField value="{!poHeader.OracleVendorNumber__c}" id="pohOracleVendorNumber" />
                                    </apex:pageBlockSectionItem>						
            
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="{!$ObjectType.VendorSite__c.Fields.State__c.Label}" for="pohOracleVendorState"/>
                                        <apex:outputField value="{!poHeader.VendorSite__r.State__c}" id="pohOracleVendorState" />
                                    </apex:pageBlockSectionItem>
            
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="{!$ObjectType.POHeader__c.Fields.OracleVendorSiteId__c.Label}" for="pohOracleVendorSiteId"/>
                                        <apex:outputField value="{!poHeader.OracleVendorSiteId__c}" id="pohOracleVendorSiteId" />
                                    </apex:pageBlockSectionItem>		
            
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="{!$ObjectType.VendorSite__c.Fields.Country__c.Label}" for="pohOracleVendorCountry"/>
                                        <apex:outputField value="{!poHeader.VendorSite__r.Country__c}" id="pohOracleVendorCountry" />
                                    </apex:pageBlockSectionItem>
            
                                    <apex:pageBlockSectionItem >
            
                                    </apex:pageBlockSectionItem>
            
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="{!$ObjectType.VendorSite__c.Fields.PostalCode__c.Label}" for="pohOracleVendorPostal"/>
                                        <apex:outputField value="{!poHeader.VendorSite__r.PostalCode__c}" id="pohOracleVendorPostal" />
                                    </apex:pageBlockSectionItem>	
            
                                </apex:pageBlockSection>
                                
                                <apex:pageBlockSection columns="1" title="Purchase Order Line Items" rendered="{!allowNewPOLineItems}" id="pbStatus">
                                    <div class="customHelpText">
                                        <div class="customHelpBody">
                                            This section shows all the PO Line Items raised on this PO (a single PO may contain one or many line items).  Click 
                                            on "Add Purchase Order Line Item " to add new/additional line items.
                                        </div>
                                    </div>
                                    <apex:pageBlockSectionItem >
                                        <apex:outputPanel >
                                            <div align="center">
                                                <apex:commandButton value="Add Purchase Order Line Item" action="{!gotoPOLineItemPage}" rendered="{!if(poHeader.Id != null, 'true', 'false')}"/>
                                            </div>	
                                        </apex:outputPanel>                                            
                                    </apex:pageBlockSectionItem>
                                    <apex:pageBlockSectionItem >
                                    	<apex:pageBlockTable value="{!poLineItems}" var="poLineItem">	
                                            <apex:column styleClass="{!if(poLineItem.IsArchived__c == true, 'archive', '')}">
                                                <apex:facet name="header">Action</apex:facet>
                                                <div style="display:{!if(poLineItem.IsArchived__c == true || poLineItem.CancelFlag__c == true, 'none', 'block')};">
                                                    <a href="{!URLFOR('/apex/ECO_PurchaseOrderLineItem', null,["id"=poLineItem.Id,"retURL"=retUrl])}">{!if(poLineItem.OracleSyncDatetime__c == null, 'Edit', 'Change')}</a>
                                                </div>                                                
                                            </apex:column>
                                            <apex:column styleClass="{!if(poLineItem.IsArchived__c == true, 'archive', '')}">
                                                <apex:facet name="header">{!$ObjectType.POLineItem__c.Fields.LineNumber__c.Label}</apex:facet>
                                                {!poLineItem.LineNumber__c}
                                            </apex:column>                                                    
                                            <apex:column styleClass="{!if(poLineItem.IsArchived__c == true, 'archive', '')}">
                                                <apex:facet name="header">{!$ObjectType.POLineItem__c.Fields.LineDescription__c.Label}</apex:facet>
                                                {!poLineItem.LineDescription__c}
                                            </apex:column>
                                            <apex:column styleClass="{!if(poLineItem.IsArchived__c == true, 'archive', '')}">
                                                <apex:facet name="header">{!$ObjectType.POLineItem__c.Fields.ProjectTask__c.Label}</apex:facet>
                                                {!poLineItem.ProjectTask__r.ProjectTaskNumber__c} ({!poLineItem.ProjectTask__r.Name})
                                            </apex:column>                                           
                                            <apex:column styleClass="{!if(poLineItem.IsArchived__c == true, 'archive', '')}">
                                                <apex:facet name="header">{!$ObjectType.POLineItem__c.Fields.LineType__c.Label}</apex:facet>
                                                {!poLineItem.LineType__c}
                                            </apex:column>
                                            <apex:column styleClass="{!if(poLineItem.IsArchived__c == true, 'archive', '')}">
                                                <apex:facet name="header">{!$ObjectType.POLineItem__c.Fields.Quantity__c.Label}</apex:facet>
                                                {!poLineItem.Quantity__c}
                                            </apex:column>
                                            <apex:column styleClass="{!if(poLineItem.IsArchived__c == true, 'archive', '')}">
                                                <apex:facet name="header">{!$ObjectType.POLineItem__c.Fields.UnitofMeasure__c.Label}</apex:facet>
                                                {!poLineItem.UnitOfMeasureUserDefined__c}
                                            </apex:column>
                                            <apex:column styleClass="{!if(poLineItem.IsArchived__c == true, 'archive', '')}">
                                                <apex:facet name="header">{!$ObjectType.POLineItem__c.Fields.UnitPrice__c.Label}</apex:facet>
                                                {!poLineItem.UnitPrice__c}
                                            </apex:column>        
                                            <apex:column styleClass="{!if(poLineItem.IsArchived__c == true, 'archive', '')}">
                                                <apex:facet name="header">{!$ObjectType.POLineItem__c.Fields.Amount__c.Label}</apex:facet>
                                                {!poLineItem.Amount__c}
                                            </apex:column>                                                
                                            <apex:column styleClass="{!if(poLineItem.IsArchived__c == true, 'archive', '')}">
                                                <apex:facet name="header">{!$ObjectType.POLineItem__c.Fields.ExpenditureType__c.Label}</apex:facet>
                                                {!poLineItem.ExpenditureType__c}
                                            </apex:column>
                                            <apex:column styleClass="{!if(poLineItem.IsArchived__c == true, 'archive', '')}">
                                                <apex:facet name="header">Cancelled</apex:facet>
                                                {!if(poLineItem.CancelFlag__c == true, 'Y', 'N')}
                                            </apex:column>
                                            <apex:column styleClass="{!if(poLineItem.IsArchived__c == true, 'archive', '')}">
                                                <apex:facet name="header">Submitted</apex:facet>																			
                                                <c:ECO_DateFormat date="{!poLineItem.OracleSyncDatetime__c}" />
                                            </apex:column>						
                                        </apex:pageBlockTable> 
                                    </apex:pageBlockSectionItem>
                                </apex:pageBlockSection>
                                
                                <apex:pageBlockSection columns="1" title="Purchase Order Status" rendered="{!allowNewPOLineItems}">
                                    <div class="customHelpText">
                                        <div class="customHelpBody">
                                            This section shows the current status of the PO - the total summary values and a list of the AP 
                                            Invoices received from the sub/vendor which have been entered into Oracle and allocated against this PO.
                                        </div>
                                    </div>
                                    <apex:pageBlockSectionItem >
                                        <apex:outputPanel >
                                            <apex:outputLabel value="Total Purchase Order Amount:"/>
                                            <c:ECO_HelpIcon helpText="The Total Amount of the overall PO (this is the sum of the individual line items entered)." />
                                        </apex:outputPanel>
                                        <apex:outputText value="{!totalPurchaseOrderLineAmount}"/>
                                    </apex:pageBlockSectionItem>
                                    <apex:pageBlockSectionItem >
                                        <apex:outputPanel >
                                            <apex:outputLabel value="Total Allocated Amount:"/>
                                            <c:ECO_HelpIcon helpText="The Toal Amount of all Accounts Payable Invoices that have been matched against or allocated to this 
                                                                      PO upon entry into Oracle and being chraged to this project.  This does not indicate how much has 
                                                                      been paid to the sub/vendor.  Refer to the table below for further details  on invoices, including 
                                                                      payment date." />
                                        </apex:outputPanel>                                        
                                        <apex:outputText value="{!totalAllocatedAmount}" />
                                    </apex:pageBlockSectionItem>
                                    <apex:pageBlockSectionItem >
                                        <apex:outputPanel >
                                            <apex:outputLabel value="Total Remaining Amount:"/>
                                            <c:ECO_HelpIcon helpText="The balance of the PO yet to be allocated against an invoice from the sub/vendor." />
                                        </apex:outputPanel>                                        
                                        <apex:outputText value="{!totalRemainingAmount}" />
                                    </apex:pageBlockSectionItem>
                                    <apex:pageBlockTable value="{!poStatusList}" var="poStatus">
                                        <apex:column >
                                            <apex:facet name="header">{!$ObjectType.POStatus__c.Fields.APInvoiceNumber__c.Label}</apex:facet>
                                            {!poStatus.APInvoiceNumber__c}
                                        </apex:column>
                                        <apex:column >
                                            <apex:facet name="header">{!$ObjectType.POStatus__c.Fields.APTotalAmount__c.Label}</apex:facet>                                            
                                            <apex:outputText value="{0, number, ###,###,###,##0}">
                                                <apex:param value="{!poStatus.APTotalAmount__c}" />
                                            </apex:outputText>	
                                        </apex:column>
                                        <apex:column >
                                            <apex:facet name="header">{!$ObjectType.POStatus__c.Fields.APPaidDate__c.Label}</apex:facet>
                                            {!poStatus.APPaidDate__c}
                                        </apex:column>
                                    </apex:pageBlockTable>                                    
                                </apex:pageBlockSection>
                            </apex:pageBlock>
                        </apex:tab>
                        <apex:tab label="Request JSON" id="tabJSON">
                            <apex:commandButton value="Refresh JSON" action="{!refreshJSON}" reRender="txtJSON"/><br/>
                            <apex:inputTextarea cols="200" rows="30" value="{!sJSON}" id="txtJSON" />
                        </apex:tab>
                    </apex:tabPanel>		
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
            
            <apex:pageBlockSection columns="1" title="Oracle Sync History" id="syncHistorySection" rendered="{!allowNewPOLineItems}">
                <apex:pageBlockSectionItem >		
                    <apex:tabPanel switchType="client" selectedTab="successSync">
                        <apex:tab label="Successful Syncs ({!numSuccessfulSyncs})" id="successSync">
                            <apex:pageMessage severity="INFO" rendered="{!!hasSyncHistory}" summary="No sync history exists."></apex:pageMessage>									
                            <apex:pageBlockTable value="{!syncHistory}" var="history" rendered="{!hasSyncHistory}">					
                                <apex:column >
                                    <apex:facet name="header">{!$ObjectType.IntegrationMessageQueue__c.Fields.Status__c.Label}</apex:facet>
                                    <apex:image url="{!URLFOR($Resource.GreenLight)}" height="20px" width="20px" />
                                </apex:column>					
                                <apex:column >
                                    <apex:facet name="header">{!$ObjectType.IntegrationMessageQueue__c.Fields.SuccessMessage__c.Label}</apex:facet>
                                    {!history.msgQueue.SuccessMessage__c}
                                </apex:column>
                                <apex:column >
                                    <apex:facet name="header">Date Processed</apex:facet>
                                    {!history.syncLocalDateTime}
                                </apex:column>
                            </apex:pageBlockTable>	
                        </apex:tab>
                        <apex:tab label="Failed/Attempted Syncs ({!numFailedAttemptedSyncs})" id="failedSync">
                            <apex:pageMessage severity="INFO" rendered="{!!hasRequestFailures}" summary="No sync failures exists."></apex:pageMessage>									
                            <apex:pageBlockTable value="{!requestFailures}" var="failure" rendered="{!hasRequestFailures}">				
                                <apex:column >
                                    <apex:facet name="header">{!$ObjectType.IntegrationMessageQueue__c.Fields.Status__c.Label}</apex:facet>
                                    <apex:image url="{!if(failure.msgQueue.ErrorMessage__c == '' || failure.msgQueue.ErrorMessage__c == null, URLFOR($Resource.YellowLight), URLFOR($Resource.RedLight))}" height="20px" width="20px" />{!failure.msgQueue.Status__c}
                                </apex:column>					
                                <apex:column >
                                    <apex:facet name="header">{!$ObjectType.IntegrationMessageQueue__c.Fields.ErrorMessage__c.Label}</apex:facet>
                                    {!failure.msgQueue.ErrorMessage__c}
                                </apex:column>
                                <apex:column >
                                    <apex:facet name="header">Date Attempted</apex:facet>
                                    {!failure.syncLocalDateTime}
                                </apex:column>
                            </apex:pageBlockTable>	
                        </apex:tab>                    
                    </apex:tabPanel>
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
		</apex:pageBlock>
    	<apex:outputPanel id="msgPanelBottom">
			<apex:pageMessages escape="false"></apex:pageMessages>
		</apex:outputPanel>

		<apex:outputPanel id="msgPollingBottom" >
			<div style="display:{!if(showPollingMsg==true, 'block', 'none')}">
				<apex:pageMessage escape="false" summary="{!pollingMessageQueueMsgBottom}" severity="INFO" ></apex:pageMessage>
			</div>
		</apex:outputPanel>
        
        <c:ECO_ModalDialog width="350" padding="0px 0px 0px 0px" name="modalDialogOracleLogin">
            <apex:pageBlock title="Oracle Authentication">
                <div>
                    <apex:outputText >Your Oracle security token has expired - please enter your Oracle credentials below to renew the token</apex:outputText>
                </div>
                <br/><br/>
                <div align="center">
                    <apex:outputText style="font-weight:bold" value="Oracle Username:"/>
                    <apex:inputText label="Oracle Username:" value="{!OracleUserName}" id="username"/><br/>
        
                    <apex:outputText style="font-weight:bold" value="Oracle Password:"/>
                    <apex:inputSecret label="Oracle Password" value="{!OraclePassword}" id="password"/><br/><br/>
                </div>

                <apex:outputPanel id="btn1">
                    <apex:outputPanel rendered="{!authenticationResult != 'SUCCESS'}">
                        <div align="center">
                            <apex:outputPanel layout="inline" styleClass="btn" onclick="authenticate()">Login</apex:outputPanel>
                            <apex:outputPanel layout="inline" styleClass="btn" onclick="cancelModal()">Cancel</apex:outputPanel>
                        </div>
                    </apex:outputPanel>
                </apex:outputPanel>

                <apex:outputPanel id="btn2">
                    <apex:outputPanel rendered="{!authenticationResult == 'SUCCESS'}">
                        <div align="center">
                            <apex:outputPanel layout="inline" styleClass="btn" onclick="closeAuthenticationModal()">Close</apex:outputPanel>
                        </div>
                    </apex:outputPanel>
                </apex:outputPanel>

                <apex:outputPanel id="result">
                    <apex:outputPanel rendered="{!authenticationResult != null}" ><br/>
                        <b>Result: </b><apex:outputText value="{!authenticationResult}" id="authenticationResult" />
                    </apex:outputPanel>
                </apex:outputPanel>
    
                <apex:actionStatus id="queryStatus">
                    <apex:facet name="start">
                        <p style="padding-bottom:20px;text-align:center;" class="searchText"><img style="position:relative;top:24px;" src="/img/loading32.gif" /> Authenticating...</p>
                    </apex:facet>
                </apex:actionStatus>
            </apex:pageBlock>
        </c:ECO_ModalDialog>
        
        <apex:actionFunction name="authenticateCredentials" action="{!authenticateCredentials}" rerender="result, btn1, btn2" status="queryStatus" immediate="true">
            <apex:param name="username" value=""/>
            <apex:param name="password" value=""/>
        </apex:actionFunction>
        
        <apex:actionStatus id="closeAuthentication">
            <apex:facet name="start">
                <p style="padding-bottom:20px;text-align:center;" class="searchText"><img style="position:relative;top:24px;" src="/img/loading32.gif" /> Closing...</p>
            </apex:facet>
        </apex:actionStatus>
        
        <apex:actionFunction name="closeAuthenticationWindow" action="{!closeAuthenticationWindow}" status="closeAuthentication" immediate="true"/>
	</apex:form>
	<apex:relatedList list="ProcessSteps" id="approvalHistory" ></apex:relatedList>

    <script type="text/javascript">
        function showHideDivisions(){
            var id = j$("[id*=pbsDistributions]").attr('id');
            twistSection(document.getElementById(id).getElementsByTagName('img')[0]);
        }
        
        j$(document).ready(function(){
            j$("input[name='piSubmit']").hide();
        });    
    </script>
</apex:page>