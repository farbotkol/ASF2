<apex:page tabStyle="pse__Proj__c"   standardController="ProjectOrganization__c" extensions="ECO_OrganizationFinderController" showHeader="true" sidebar="false">
    <style>
        .searchTable select{
            min-width:250px;
        }

        .searchTable label{
            font-weight:bold;
            display:block;
        }

        .searchText{
            text-align:center;
            font-weight:bold;
            font-size:20px;
        }

        .colA {
            text-align:right;
            vertical-align:middle !important;
        }

        .colB {
            vertical-align:middle !important;
        }

        .colC {
            text-align:left;
            vertical-align:middle !important;
        }       
        .fixedPickList{
            width: 350px;
        }
        .fixedName{
            width: 345px;
        }

    </style>

    <apex:sectionHeader title="Organization Finder" subtitle="Selecting Organizations for Project {!ProjectOrganization__c.Project__r.Name}" />
    <apex:form >
        <apex:outputPanel id="messages">
            <apex:pageMessages />
        </apex:outputPanel>

         <apex:pageBlock rendered="{!NOT(ISNULL(ProjectOrganization__c.Project__c))}" id="organizationSection" title="Selected Organizations">
            <apex:pageBlockButtons location="top">
                <apex:commandButton action="{!SaveRecords}" value="Save" rerender="messages, organizationSection" status="selectStatus" disabled="{!bUpdateContributionDisabled}" />
                <apex:commandButton action="{!Cancel}" value="Return to Project" />
            </apex:pageBlockButtons>

            <apex:outputPanel id="searchSection">
                <apex:pageBlockSection title="Selected Organizations" columns="1" collapsible="false" />
                <div style="padding:0 12px;margin-top:7px">
                <apex:actionStatus id="selectStatus">
                    <apex:facet name="start">
                        <p style="padding-bottom:20px;" class="searchText"><img style="position:relative;top:12px;" src="/img/loading32.gif" /> Updating...</p>
                    </apex:facet>
                    <apex:facet name="stop">
                        <apex:outputPanel >


                            <apex:pageMessage title="Warning" severity="WARNING" strength="3" rendered="{!AND(IF(primarySite.OUID__c == oProject.CarryingOutOrganization__r.OUID__c, false, true), if(oProject.CarryingOutOrganization__r.OUID__c == null, false, true))}" summary="A client record has been selected that is not associated with the project owning organization. Contact Shared Services to create a client record within the owning organization to avoid a future Oracle syncing error when booking the project."></apex:pageMessage> 


                            <apex:outputPanel rendered="{!if(lSelectedOrganizations.size > 0, false, true)}">
                                <p style="padding-bottom:20px;">No Organizations have been selected</p>
                            </apex:outputPanel>

                            <apex:pageBlockTable rendered="{!if(lSelectedOrganizations.size > 0, true, false)}" value="{!lSelectedOrganizations}" var="organization">
                                <apex:column >
                                    <apex:facet name="header">Action</apex:facet>
                                    <apex:commandLink action="{!SelectPrimary}" value="Make Primary" rendered="{!not(oProject.OracleSyncStatus__c='S')}" rerender="messages, organizationSection, searchSection" status="selectStatus">
                                        <apex:param assignTo="{!sSelectedOrganizationId}" name="OrganizationId" value="{!organization.OrganizationString__r.Id}" />
                                    </apex:commandLink>&nbsp;&nbsp;
                                    <apex:commandLink action="{!RemoveEntry}" value="Remove" rendered="{!NOT(AND(organization.Type__c='Primary', oProject.OracleSyncStatus__c='S'))}" rerender="messages, organizationSection, searchSection" status="selectStatus">
                                        <apex:param assignTo="{!sSelectedOrganizationId}" name="OrganizationId" value="{!organization.OrganizationString__r.Id}" />
                                    </apex:commandLink>
                                </apex:column>
                                <apex:column value="{!organization.Type__c}"/>
                                <apex:column value="{!organization.OrganizationString__r.OrganizationName__c}"/>
                                <apex:column value="{!organization.OrganizationString__r.GeographyName__c}"/> 
                                <apex:column value="{!organization.OrganizationString__r.Region__c}"/> 
                                <apex:column value="{!organization.OrganizationString__r.District__c}"/>
                                <apex:column headerValue="Office" value="{!organization.OrganizationString__r.LocationName__c}"/>
                                <apex:column value="{!organization.OrganizationString__r.BusinessLineName__c}"/>
                                <apex:column value="{!organization.OrganizationString__r.Department__c}"/>
                                <apex:column style="text-align:right;">
                                    <apex:facet name="header">Contribution %</apex:facet>
                                    <apex:inputField style="width:4em;text-align:right;" value="{!organization.ContributionPercent__c}" />&nbsp;&#37;
                                </apex:column> 
                            </apex:pageBlockTable>
                        </apex:outputPanel>
                    </apex:facet>
                </apex:actionStatus>
                </div>
                <br/><br />

                <apex:outputpanel >
                <apex:pageBlockSection title="Your Owning Organization" collapsible="false"></apex:pageBlockSection>
                <div style="padding:0 12px;margin-top:7px">
                <apex:outputText Value="No Owning Organizations Found." rendered="{!IF(lUserOrganizations.size > 0, false, true)}" />
                <apex:pageBlockTable value="{!lUserOrganizations}" var="organization" rendered="{!IF(lUserOrganizations.size > 0, true, false)}">
                    <apex:column width="200px">
                        <apex:facet name="header">Action</apex:facet>
                        <apex:commandLink action="{!SelectPrimary}" value="Set Primary"  rendered="{!not(oProject.OracleSyncStatus__c='S')}"  rerender="messages, buttons, tabPanel, searchSection" status="selectStatus">
                            <apex:param assignTo="{!sSelectedOrganizationId}" name="OrganizationId" value="{!organization.Id}" />
                        </apex:commandLink>&nbsp;&nbsp;
                        <apex:commandLink action="{!SelectSecondary}" value="Set Supporting" rerender="messages, buttons, tabPanel, searchSection" status="selectStatus">
                            <apex:param assignTo="{!sSelectedOrganizationId}" name="OrganizationId" value="{!organization.Id}" />
                        </apex:commandLink>
                    </apex:column>
                    <apex:column value="{!organization.OrganizationName__c}"/>
                    <apex:column value="{!organization.GeographyName__c}"/> 
                    <apex:column value="{!organization.Region__c}"/> 
                    <apex:column value="{!organization.District__c}"/>
                    <apex:column headerValue="Office" value="{!organization.LocationName__c}"/>
                    <apex:column value="{!organization.BusinessLineName__c}"/>
                    <apex:column value="{!organization.Department__c}"/>
                    
                </apex:pageBlockTable>
                </div>
                </apex:outputPanel>

                <apex:pageBlockSection title="Search For Organizations" columns="1"  collapsible="false" />
                <div style="padding:0 12px;margin-top:7px">
                <apex:panelGrid columns="3" columnClasses="colA, colB, colC" id="theGrid">
                    <apex:outputLabel for="Name" value="Organization Name" />
                    <apex:inputText title="Organization Name" styleClass="fixedName"  id="Name" value="{!sOrganizationName}" />
                    <apex:commandButton value="Search" action="{!SearchOrganizations}" rerender="messages, searchSection" status="searchStatus"/>

                    <apex:outputLabel for="GeographyName" value="Geography Name" />
                    <apex:selectList styleClass="fixedPickList" size="1" id="GeographyName" value="{!sGeographyName}">
                        <apex:selectOption itemValue="" itemLabel="Select"/>
                        <apex:selectOptions value="{!loGeographies}"/>
                        <apex:actionSupport event="onchange" action="{!SearchOrganizations}" rerender="messages, searchSection" status="searchStatus"/>
                    </apex:selectList>  
                    <apex:outputText value="" />

                    <apex:outputLabel for="Region" value="Region" />
                    <apex:selectList styleClass="fixedPickList" size="1" id="Region" value="{!sRegion}">
                        <apex:selectOption itemValue="" itemLabel="Select"/>
                        <apex:selectOptions value="{!loRegions}"/>
                        <apex:actionSupport event="onchange" action="{!SearchOrganizations}" rerender="messages, searchSection" status="searchStatus"/>
                    </apex:selectList>  
                    <apex:outputText value="" />

                    <apex:outputLabel for="District" value="District" />
                    <apex:selectList styleClass="fixedPickList" size="1" id="District" value="{!sDistrict}">
                        <apex:selectOption itemValue="" itemLabel="Select"/>
                        <apex:selectOptions value="{!loDistricts}"/>
                        <apex:actionSupport event="onchange" action="{!SearchOrganizations}" rerender="messages, searchSection" status="searchStatus"/>
                    </apex:selectList>
                    <apex:outputText value="" />

                    <apex:outputLabel for="Office" value="Office" />
                    <apex:selectList styleClass="fixedPickList" size="1" id="Office" value="{!sLocation}">
                        <apex:selectOption itemValue="" itemLabel="Select"/>
                        <apex:selectOptions value="{!loLocations}"/>
                        <apex:actionSupport event="onchange" action="{!SearchOrganizations}" rerender="messages, searchSection" status="searchStatus"/>
                    </apex:selectList>
                    <apex:outputText value="" />

                    <apex:outputLabel for="BusinessLine" value="Business Line" />
                    <apex:selectList styleClass="fixedPickList" size="1" id="BusinessLine" value="{!sBusinessLine}">
                        <apex:selectOption itemValue="" itemLabel="Select"/>
                        <apex:selectOptions value="{!loBusinessLines}"/>
                        <apex:actionSupport event="onchange" action="{!SearchOrganizations}" rerender="messages, searchSection" status="searchStatus"/>
                    </apex:selectList>
                    <apex:outputText value="" />

                    <apex:outputLabel for="Department" value="Department" />
                    <apex:selectList styleClass="fixedPickList" size="1" id="Department" value="{!sDepartment}">
                        <apex:selectOption itemValue="" itemLabel="Select"/>
                        <apex:selectOptions value="{!loDepartments}"/>
                        <apex:actionSupport event="onchange" action="{!SearchOrganizations}" rerender="messages, searchSection" status="searchStatus"/>
                    </apex:selectList>
                    <apex:outputText value="" />


                </apex:panelGrid>
                </div>

                <apex:actionStatus id="searchStatus">
                    <apex:facet name="start">
                        <p style="padding-bottom:20px;" class="searchText"><img style="position:relative;top:12px;" src="/img/loading32.gif" /> Searching...</p>
                    </apex:facet>
                    <apex:facet name="stop">
                        <apex:outputPanel >
                            <apex:pageBlockSection rendered="{!bSearchInProgress}" title="Search Results" collapsible="false"></apex:pageBlockSection>
                            <apex:pageBlockTable rendered="{!bSearchInProgress}" value="{!lOrganizations}" var="organization">
                                <apex:column >
                                    <apex:facet name="header">Action</apex:facet>
                                    <apex:commandLink action="{!SelectPrimary}" value="Set Primary"  rendered="{!not(oProject.OracleSyncStatus__c='S')}"  rerender="messages, organizationSection, searchSection" status="selectStatus">
                                        <apex:param assignTo="{!sSelectedOrganizationId}" name="OrganizationId" value="{!organization.Id}" />
                                    </apex:commandLink>&nbsp;&nbsp;
                                    <apex:commandLink action="{!SelectSecondary}" value="Set Supporting" rerender="messages, organizationSection, searchSection" status="selectStatus">
                                        <apex:param assignTo="{!sSelectedOrganizationId}" name="OrganizationId" value="{!organization.Id}" />
                                    </apex:commandLink>
                                </apex:column>
                                <apex:column value="{!organization.OrganizationName__c}"/>
                                <apex:column value="{!organization.GeographyName__c}"/> 
                                <apex:column value="{!organization.Region__c}"/> 
                                <apex:column value="{!organization.District__c}"/>
                                <apex:column headerValue="Office" value="{!organization.LocationName__c}"/>
                                <apex:column value="{!organization.BusinessLineName__c}"/>
                                <apex:column value="{!organization.Department__c}"/>
                            </apex:pageBlockTable>
                            <BR /><BR />
                            <apex:outputpanel rendered="{!bSearchInProgress}" >
                                <div style="text-align:center;">
                                    <apex:commandButton value="{!showMoreOrgText}" action="{!toggleOrgShow}"  rerender="messages, searchSection"  status="searchStatus" rendered="{!bShowMoreButtonOrg}" />
                                </div>
                            </apex:outputPanel>
                        </apex:outputPanel>
                    </apex:facet>
                </apex:actionStatus>
            </apex:outputPanel>
        </apex:pageBlock>
    </apex:form>
</apex:page>